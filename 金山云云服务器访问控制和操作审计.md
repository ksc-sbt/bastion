# 金山云云服务器访问控制和操作审计

公有云给用户不仅仅带来弹性和按量计费的资源，也提供了在任何地方操作和使用资源的灵活性。但是，为了保证用户在云上环境的安全性，避免环境管理混乱，需要对云资源的操作和访问进行严格的访问控制和操作审计。为了达到这一目标，用户可以采用专业的堡垒机软件，也可以通过利用Linux操作系统，并结合云网络的特性来实现。

本文介绍如何利用金山云的云网络能力，并通过配置Linux系统来实现堡垒机，提高对金山云云服务器的访问控制和操作审计。本方案的整体架构描述如下图：

![金山云云服务器堡垒机部署架构](https://raw.githubusercontent.com/ksc-sbt/bastion/master/kec-bastion.png)

本指南包含如下内容：
* 网络规划；
* 准备云服务器；
* 配置堡垒机；
* 验证访问控制和审计。

# 1 网络规划
本指南所使用的环境位于金山云北京6区。

## 1.1 VPC配置

|  网络资源   | 名称  | CIDR  |
|  ----  | ----  | ----  |
| VPC  | sbt-vpc |	10.34.0.0/16 |

## 1.2 子网配置

| 子网名称 | 所属VPC |可用区 | 子网类型  | CIDR  | 说明|
|  ----  | ----  | ----  |----  |----  |----|
| public_a  | sbt-vpc |	可用区A | 普通子网| 10.34.51.0/24|用于堡垒机|
| private_a  | sbt-vpc |	可用区A | 普通子网| 10.34.0.0/20|用于云服务器|


## 1.3 安全组配置
作为实验环境，创建安全组sg-bastion和sg-app，其中绑定sg-bastion的云服务器可以被外网ping通，以及通过ssh访问。sg-bastion的入站规则如下：

|协议|行为|起始端口|结束端口|源IP|
|----|----|----|----|----|
|ICMP|允许|全部协议|全部协议|0.0.0.0/0|
|TCP|允许|22|22|0.0.0.0/0|

sg-bastion的出站规则采用如下默认设置：
|协议|行为|起始端口|结束端口|源IP|
|----|----|----|----|----|
|IP|允许|-|-|0.0.0.0/0|

安全组sg-app将绑定到应用服务器上。应用服务器可以被外部访问80端口（提供HTTP服务），并可接受来自于堡垒机（堡垒机的内部IP为10.34.51.13)的SSH请求，同时也可以被其他云服务器ping通。因此，sg-app的入站规则如下：
|协议|行为|起始端口|结束端口|源IP|
|----|----|----|----|----|
|ICMP|允许|全部协议|全部协议|0.0.0.0/0|
|TCP|允许|22|22|10.34.51.13/32|
|HTTP|允许|80|80|0.0.0.0/0|
安全组sg-app的出站规则采用和sg-bastion相同出站规则。

## 1.3 网络ACL配置
应用服务器不能被外网访问，但可以通过公网NAT访问外网服务（120.92.15.230是金山云短信服务域名ksms.api.ksyun.com的IP地址）。为了限制所能访问的外网服务，将为应用服务器所在的私有子网private_a（10.34.0.0/20）绑定一个网络ACL。该网络ACL的入站规则配置如下：

|优先级|协议|行为|起始端口|结束端口|目标IP|备注|
|----|----|----|----|----|----|----|
|100|IP|允许|-|-|0.0.0.0/0|可接受任意包|

出站规则配置如下：
|优先级|协议|行为|起始端口|结束端口|目标IP|备注|
|----|----|----|----|----|----|----|
|100|IP|允许|-|-|10.34.0.0/16|可访问VPC中的任意服务|
|200|UDP|允许|53|53|0.0.0.0/0|DNS服务|
|210|ICMP|允许|全部协议|全部协议|0.0.0.0/0|ping|
|300|TCP|允许|80|80|219.216.128.25/32|neusoft大学yum源|
|310|TCP|允许|80|80|198.18.254.30/32|金山云yum源|
|400|TCP|允许|443|443|120.92.15.230/32|金山云短信服务|
|500|IP|拒绝|-|-|0.0.0.0/0|拒绝其他服务|


## 1.4 NAT配置信息
为了私有云子网的云服务器能访问外网服务（比如金山云短信服务），因此需要配置公网NAT实例。下面是NAT实例的配置信息。

|名称|所属VPC|作用范围|类型|所绑定的子网|
|  ----  | ----  | ----  |----  |----  |
|Ksc_Nat|sbt-vpc|绑定的子网|公网|private_a|

## 1.5 负载均衡配置

|负载均衡名称|IP版本|状态|网络类型|所属项目|VPC实例名|弹性IP|
|----|----|----|----|----|----|----|
|ymq-slb001|IPv4|开启|公网|SBT|sbt-vpc|120.131.1.39|

在该负载均衡实例下创建侦听器。此外，如果需要限制某些客户端访问，可以通过绑定ACL，实现对某些IP地址的封禁。

![金山云云服务器堡垒机部署架构](https://raw.githubusercontent.com/ksc-sbt/bastion/master/slb-acl.png)

下面是用于绑定到负载均衡实例侦听器上的网络ACL acl-slb，当前配置的规则是不限制任何访问IP。acl-slb的入站规则如下（负载均衡服务下创建的访问控制ACL无需定义出站规则）。
|优先级|协议|行为|起始端口|结束端口|目标IP|备注|
|----|----|----|----|----|----|----|
|100|IP|允许|-|-|0.0.0.0/0|可接受任意包|

# 2 准备云服务器
金山云的云服务器可以非为全云盘（系统盘和数据盘都是云硬盘）和非全云盘两大类。全云盘服务器提供了更好的SLA，而非全云盘服务器可以充分利用本地盘的磁盘能力。
为了提高堡垒机的可用性，建议采用全云盘服务器。此外，该服务器将绑定一个弹性IP。为了避免被云服务器SSH账户密码被暴力破解，禁用口令登录，而采用SSH密钥登录。下面是堡垒机云服务器的配置信息
|名称|类型|所属于VPC|所属子网|配置|IPV4地址|安全组|操作系统|登录方式|弹性IP|
|  ----  | ----  | ----  |----  |----  |----  |----  |----  |----  |----|
|ymq-bastion|通用型N3|sbt-vpc|public_a|2核8G|10.34.51.13|sg-bastion|CentOS Linux release 7.7.1908 (Core)|SSH Kkey|120.92.42.167|

应用服务器位于私有子网，可提供口令登录。下面是一台应用服务器的配置。
|名称|类型|所属于VPC|所属子网|配置|IPV4地址|安全组|操作系统|登录方式
|  ----  | ----  | ----  |----  |----  |----  |----  |----  |----  |
|ymq-srv-1|通用型N3|sbt-vpc|private_a|8核32G|10.32.0.2|sg-app|CentOS Linux release 7.7.1908 (Core)|密码|

# 3 配置堡垒机


```


# 4 验证访问控制和审计

# 5 总结
本文介绍了通过Keepalived，实现虚拟IP在不同云主机之间的自动漂移，并通过在主、从切换时自动运行脚本调用金山云配置主机路由，实现两台云服务器能被外部用一个IP地址访问。此外，由于金山云主机路由的下一跳不仅仅可以是云服务器，还可以是云物理主机，因此，采用该方法也可以实现在金山云云物理主机上自建高可用服务。
